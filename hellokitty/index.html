<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hello Kitty Racing Adventure</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Comic Sans MS', cursive, sans-serif;
            background: linear-gradient(135deg, #ff9ec7 0%, #ffb3d9 50%, #ffcce6 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden;
            padding: 10px;
        }

        #gameContainer {
            width: 100%;
            max-width: 1000px;
            height: 100vh;
            max-height: 700px;
            aspect-ratio: 1000 / 700;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        @media (max-width: 1024px) {
            #gameContainer {
                width: 95vw;
                height: 95vh;
                max-height: 95vh;
            }
        }

        @media (max-width: 768px) {
            #gameContainer {
                width: 100vw;
                height: 100vh;
                max-height: 100vh;
                border-radius: 0;
            }
        }

        /* Character Selection Screen */
        #characterSelection {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            background: linear-gradient(135deg, #ff9ec7 0%, #ffb3d9 100%);
            padding: 15px;
            overflow-y: auto;
        }

        #characterSelection h1 {
            color: #fff;
            font-size: 36px;
            margin-bottom: 15px;
            margin-top: 10px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
        }

        #characterGrid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 12px;
            max-width: 900px;
            margin: 10px 0;
        }

        .character-card {
            background: #fff;
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 3px solid transparent;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .character-card:hover {
            transform: scale(1.1);
            border-color: #ff69b4;
            box-shadow: 0 6px 12px rgba(0,0,0,0.2);
        }

        .character-card.selected {
            border-color: #ff1493;
            background: #ffe6f2;
            transform: scale(1.05);
        }

        .character-emoji {
            font-size: 50px;
            margin-bottom: 8px;
        }

        .character-name {
            font-size: 12px;
            color: #333;
            font-weight: bold;
        }

        #startButton {
            margin-top: 20px;
            margin-bottom: 15px;
            padding: 15px 40px;
            font-size: 24px;
            background: #ff1493;
            color: white;
            border: none;
            border-radius: 30px;
            cursor: pointer;
            font-family: 'Comic Sans MS', cursive;
            box-shadow: 0 4px 15px rgba(255,20,147,0.4);
            transition: all 0.3s;
            position: relative;
            z-index: 10;
        }

        #startButton:hover {
            background: #ff69b4;
            transform: scale(1.05);
        }

        #startButton:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Game Screen */
        #gameScreen {
            width: 100%;
            height: 100%;
            display: none;
            position: relative;
            background: linear-gradient(to bottom, #87ceeb 0%, #98d8c8 50%, #f7dc6f 100%);
            overflow: hidden;
        }

        #gameUI {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #timer {
            background: rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 10px;
        }

        #position {
            background: rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 10px;
        }

        #raceTrack {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: visible;
        }

        .road {
            position: absolute;
            width: 40%;
            min-width: 300px;
            height: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #555;
            border-left: 20px solid #fff;
            border-right: 20px solid #fff;
            z-index: 1;
        }
        
        /* Add animated dashed center line effect */
        .road::before {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            width: 8px;
            height: 200%;
            transform: translateX(-50%);
            background: repeating-linear-gradient(
                to bottom,
                #ffffff 0px,
                #ffffff 50px,
                transparent 50px,
                transparent 100px
            );
            z-index: 2;
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
            animation: roadScroll 2s linear infinite;
        }
        
        @keyframes roadScroll {
            from { 
                top: 0;
            }
            to { 
                top: -100px;
            }
        }

        .road-line {
            position: absolute;
            width: 6px;
            height: 80px;
            background: #ffffff;
            left: 50%;
            transform: translateX(-50%);
            animation: roadLineMove 0.8s linear infinite;
            z-index: 5;
            box-shadow: 0 0 5px rgba(255,255,255,0.5);
        }

        @keyframes roadLineMove {
            from { 
                top: -80px; 
                opacity: 1;
            }
            to { 
                top: 100%; 
                opacity: 1;
            }
        }


        .treat {
            position: absolute;
            width: 50px;
            height: 50px;
            font-size: 40px;
            text-align: center;
            line-height: 50px;
            animation: treatFloat 2s ease-in-out infinite;
            z-index: 20;
            will-change: transform;
            pointer-events: none;
        }

        @keyframes treatFloat {
            0%, 100% { 
                transform: translateY(0) rotate(0deg); 
            }
            50% { 
                transform: translateY(-10px) rotate(10deg); 
            }
        }

        .player {
            position: absolute;
            width: 60px;
            height: 60px;
            font-size: 50px;
            text-align: center;
            line-height: 60px;
            z-index: 1000 !important;
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            pointer-events: none;
            background: rgba(255,255,255,0.95) !important;
            border: 4px solid #ff1493 !important;
            border-radius: 12px;
            box-shadow: 0 0 20px rgba(255,20,147,1) !important;
            will-change: transform;
            transform-origin: center center;
        }

        .opponent {
            position: absolute;
            width: 60px;
            height: 60px;
            font-size: 50px;
            text-align: center;
            line-height: 60px;
            z-index: 100;
            display: block;
            pointer-events: none;
            background: rgba(255,255,255,0.8);
            border: 3px solid #4169e1;
            border-radius: 12px;
            box-shadow: 0 0 15px rgba(65,105,225,0.6);
        }

        .player.jumping {
            animation: jump 0.5s ease-in-out;
        }

        @keyframes jump {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }

        .finish-line {
            position: absolute;
            width: 40%;
            min-width: 300px;
            height: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: repeating-linear-gradient(
                90deg,
                #000 0px,
                #000 20px,
                #fff 20px,
                #fff 40px
            );
            z-index: 10;
        }

        #restartButton {
            position: absolute;
            bottom: 10px;
            right: 10px;
            padding: 10px 20px;
            font-size: 16px;
            background: rgba(255,20,147,0.9);
            color: white;
            border: 2px solid #fff;
            border-radius: 20px;
            cursor: pointer;
            font-family: 'Comic Sans MS', cursive;
            z-index: 200;
            box-shadow: 0 4px 15px rgba(255,20,147,0.4);
            transition: all 0.3s;
        }

        #restartButton:hover {
            background: rgba(255,105,180,0.95);
            transform: scale(1.05);
        }

        /* Winner Screen */
        #winnerScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,182,193,0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 300;
        }

        #winnerScreen h2 {
            font-size: 48px;
            color: #ff1493;
            margin-bottom: 20px;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.2);
        }

        #winnerCharacter {
            font-size: 120px;
            margin: 20px 0;
        }

        #winnerTime {
            font-size: 32px;
            color: #333;
            margin-bottom: 30px;
        }

        .instructions {
            position: absolute;
            bottom: 60px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 16px;
            text-align: center;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            background: rgba(0,0,0,0.3);
            padding: 10px 20px;
            border-radius: 10px;
        }

        /* Countdown Screen */
        #countdownScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 500;
        }

        #countdownNumber {
            font-size: 150px;
            color: #fff;
            font-weight: bold;
            text-shadow: 0 0 40px rgba(255,255,255,1), 0 0 80px rgba(255,20,147,0.8);
            animation: countdownPulse 0.8s ease-out;
            line-height: 1;
        }

        @keyframes countdownPulse {
            0% { 
                transform: scale(0.3); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.3); 
            }
            100% { 
                transform: scale(1); 
                opacity: 1; 
            }
        }

        #goText {
            font-size: 120px;
            color: #ff1493;
            font-weight: bold;
            text-shadow: 0 0 50px rgba(255,20,147,1), 0 0 100px rgba(255,20,147,0.8);
            animation: goPulse 1s ease-out;
            line-height: 1;
        }

        @keyframes goPulse {
            0% { 
                transform: scale(0.2); 
                opacity: 0; 
            }
            50% { 
                transform: scale(1.4); 
            }
            100% { 
                transform: scale(1); 
                opacity: 1; 
            }
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <!-- Character Selection Screen -->
        <div id="characterSelection">
            <h1>üê± Hello Kitty Racing Adventure üê±</h1>
            <div id="characterGrid">
                <div class="character-card" data-character="kitty">
                    <div class="character-emoji">üê±</div>
                    <div class="character-name">Hello Kitty</div>
                </div>
                <div class="character-card" data-character="melody">
                    <div class="character-emoji">üê∞</div>
                    <div class="character-name">My Melody</div>
                </div>
                <div class="character-card" data-character="keroppi">
                    <div class="character-emoji">üê∏</div>
                    <div class="character-name">Keroppi</div>
                </div>
                <div class="character-card" data-character="badtz">
                    <div class="character-emoji">üêß</div>
                    <div class="character-name">Badtz-Maru</div>
                </div>
                <div class="character-card" data-character="chococat">
                    <div class="character-emoji">üê±</div>
                    <div class="character-name">Chococat</div>
                </div>
                <div class="character-card" data-character="pompom">
                    <div class="character-emoji">üê∂</div>
                    <div class="character-name">Pompompurin</div>
                </div>
                <div class="character-card" data-character="tuxedo">
                    <div class="character-emoji">üêß</div>
                    <div class="character-name">Tuxedosam</div>
                </div>
                <div class="character-card" data-character="kuromi">
                    <div class="character-emoji">üëπ</div>
                    <div class="character-name">Kuromi</div>
                </div>
                <div class="character-card" data-character="cinnamoroll">
                    <div class="character-emoji">üêï</div>
                    <div class="character-name">Cinnamoroll</div>
                </div>
            </div>
            <button id="startButton" disabled>Start Race!</button>
        </div>

        <!-- Game Screen -->
        <div id="gameScreen">
            <div id="countdownScreen">
                <div id="countdownNumber"></div>
                <div id="goText" style="display: none;">GO!</div>
            </div>
            <div id="gameUI">
                <div id="timer">Time: 0.0s</div>
                <div id="position">Treats: 0 üç∞</div>
            </div>
            <div id="raceTrack">
                <div class="road"></div>
                <div class="player" id="player"></div>
                <div class="finish-line" id="finishLine"></div>
            </div>
            <div class="instructions">
                Hold ‚Üë Arrow Key to accelerate, ‚Üê ‚Üí to steer!
            </div>
            <button id="restartButton">Restart Race</button>
            
            <!-- Winner Screen -->
            <div id="winnerScreen">
                <h2>üéâ You Won! üéâ</h2>
                <div id="winnerCharacter"></div>
                <div id="winnerTime"></div>
                <button id="playAgainButton" style="padding: 15px 40px; font-size: 24px; background: #ff1493; color: white; border: none; border-radius: 30px; cursor: pointer; font-family: 'Comic Sans MS', cursive;">Play Again!</button>
            </div>
        </div>
    </div>

    <script>
        // Game State
        let selectedCharacter = null;
        let gameStarted = false;
        let countdownActive = false;
        let countdownValue = 3;
        let gameTime = 0;
        let gameTimer = null;
        let playerSpeed = 3; // Player's forward speed
        let playerX = 500; // Player's horizontal position
        let playerY = 0; // Player's progress (starts at 0, moves up toward finish)
        let playerProgress = 0; // How far player has traveled
        let opponents = []; // Array of opponent racers
        let raceFinished = false;
        let keys = {};
        let raceDistance = 5000; // Total race distance in pixels
        let finishLineY = 0; // Finish line at top (Y = 0)

        // Character emoji mapping
        const characterEmojis = {
            kitty: 'üê±',
            melody: 'üê∞',
            keroppi: 'üê∏',
            badtz: 'üêß',
            chococat: 'üê±',
            pompom: 'üê∂',
            tuxedo: 'üêß',
            kuromi: 'üëπ',
            cinnamoroll: 'üêï'
        };

        // DOM Elements
        const characterSelection = document.getElementById('characterSelection');
        const gameScreen = document.getElementById('gameScreen');
        const characterCards = document.querySelectorAll('.character-card');
        const startButton = document.getElementById('startButton');
        const player = document.getElementById('player');
        const timerDisplay = document.getElementById('timer');
        const positionDisplay = document.getElementById('position');
        const restartButton = document.getElementById('restartButton');
        const winnerScreen = document.getElementById('winnerScreen');
        const winnerCharacter = document.getElementById('winnerCharacter');
        const winnerTime = document.getElementById('winnerTime');
        const playAgainButton = document.getElementById('playAgainButton');
        const raceTrack = document.getElementById('raceTrack');
        const finishLine = document.getElementById('finishLine');
        const countdownScreen = document.getElementById('countdownScreen');
        const countdownNumber = document.getElementById('countdownNumber');
        const goText = document.getElementById('goText');

        // Character Selection
        characterCards.forEach(card => {
            card.addEventListener('click', () => {
                // Remove previous selection
                characterCards.forEach(c => c.classList.remove('selected'));
                // Add selection to clicked card
                card.classList.add('selected');
                selectedCharacter = card.dataset.character;
                startButton.disabled = false;
            });
        });

        // Start Game
        startButton.addEventListener('click', () => {
            if (!selectedCharacter) return;
            
            characterSelection.style.display = 'none';
            gameScreen.style.display = 'block';
            
            // Set player emoji immediately
            const emoji = characterEmojis[selectedCharacter] || 'üê±';
            player.textContent = emoji;
            player.innerHTML = emoji; // Also set innerHTML as backup
            
            // Small delay to ensure DOM is ready
            setTimeout(() => {
                initGame();
                startCountdown();
            }, 50);
        });

        // Initialize Game
        function initGame() {
            // Reset cache
            containerCache = null;
            updateBounds();
            
            gameTime = 0;
            playerSpeed = 3;
            raceFinished = false;
            
            // Get container dimensions
            const gameContainerEl = document.getElementById('gameContainer');
            const containerWidth = gameContainerEl.offsetWidth;
            const containerHeight = gameContainerEl.offsetHeight;
            
            // Position player at bottom center
            playerX = containerWidth / 2;
            playerY = containerHeight - 80; // Start near bottom
            playerProgress = 0;
            
            // Set player emoji
            const emoji = characterEmojis[selectedCharacter] || 'üê±';
            player.textContent = emoji;
            player.innerHTML = emoji;
            
            // Position player visually
            const leftPos = playerX - 30;
            const topPos = playerY - 30;
            player.style.transform = `translate3d(${leftPos}px, ${topPos}px, 0)`;
            player.style.display = 'block';
            player.style.visibility = 'visible';
            player.style.opacity = '1';
            
            // Create opponents (5 AI racers)
            createOpponents();
            
            // Position finish line at top
            finishLineY = 50; // Finish line at top of screen
            finishLine.style.transform = `translate3d(-50%, ${finishLineY}px, 0)`;
            finishLine.style.display = 'block';
            finishLine.style.zIndex = '10';
        }
        
        // Create opponent racers
        function createOpponents() {
            // Remove existing opponents
            opponents.forEach(opp => {
                if (opp.element && opp.element.parentElement) {
                    opp.element.remove();
                }
            });
            opponents = [];
            
            const gameContainerEl = document.getElementById('gameContainer');
            const containerWidth = gameContainerEl.offsetWidth;
            const containerHeight = gameContainerEl.offsetHeight;
            
            // Get all character names except the selected one
            const allCharacters = Object.keys(characterEmojis);
            const availableCharacters = allCharacters.filter(char => char !== selectedCharacter);
            
            // Create 5 opponents
            const numOpponents = 5;
            const roadWidth = Math.max(containerWidth * 0.4, 300);
            const roadLeft = (containerWidth - roadWidth) / 2;
            const laneWidth = roadWidth / (numOpponents + 1);
            
            for (let i = 0; i < numOpponents; i++) {
                const charName = availableCharacters[i % availableCharacters.length];
                const emoji = characterEmojis[charName] || 'üê±';
                
                // Create opponent element
                const oppElement = document.createElement('div');
                oppElement.className = 'opponent';
                oppElement.textContent = emoji;
                oppElement.innerHTML = emoji;
                raceTrack.appendChild(oppElement);
                
                // Calculate starting position (spread across road width)
                const xPos = roadLeft + (i + 1) * laneWidth;
                const yPos = containerHeight - 80; // Start at bottom like player
                
                const opponent = {
                    element: oppElement,
                    name: charName,
                    emoji: emoji,
                    x: xPos,
                    y: yPos,
                    progress: 0,
                    speed: 2.5 + Math.random() * 1.5, // Speed between 2.5 and 4
                    finished: false,
                    position: 0
                };
                
                // Position opponent
                oppElement.style.transform = `translate3d(${xPos - 30}px, ${yPos - 30}px, 0)`;
                oppElement.style.display = 'block';
                
                opponents.push(opponent);
            }
        }

        // Create animated road lines
        function createRoadLines() {
            // Remove existing lines
            document.querySelectorAll('.road-line').forEach(line => line.remove());
            
            // Create more lines for smoother animation
            const lineSpacing = 120; // Space between lines
            const numLines = 25; // More lines for continuous effect
            
            for (let i = 0; i < numLines; i++) {
                const line = document.createElement('div');
                line.className = 'road-line';
                line.style.top = (i * lineSpacing - 80) + 'px';
                line.style.animationDelay = (i * 0.1) + 's';
                line.style.display = 'block';
                line.style.visibility = 'visible';
                raceTrack.appendChild(line);
            }
        }


        // Start Countdown
        function startCountdown() {
            countdownActive = true;
            countdownValue = 3;
            countdownScreen.style.display = 'flex';
            goText.style.display = 'none';
            countdownNumber.textContent = countdownValue;
            countdownNumber.style.display = 'block';
            
            const countdownInterval = setInterval(() => {
                countdownValue--;
                if (countdownValue > 0) {
                    countdownNumber.textContent = countdownValue;
                    countdownNumber.style.animation = 'none';
                    void countdownNumber.offsetWidth; // Trigger reflow
                    countdownNumber.style.animation = 'countdownPulse 0.5s ease-out';
                } else if (countdownValue === 0) {
                    countdownNumber.style.display = 'none';
                    goText.style.display = 'block';
                    goText.style.animation = 'goPulse 0.8s ease-out';
                    setTimeout(() => {
                        countdownScreen.style.display = 'none';
                        countdownActive = false;
                        gameStarted = true;
                        startGameLoop();
                    }, 800);
                    clearInterval(countdownInterval);
                }
            }, 1000);
        }

        // Start Game Loop
        function startGameLoop() {
            // Start timer
            gameTimer = setInterval(() => {
                if (!raceFinished && gameStarted) {
                    gameTime += 0.1;
                    timerDisplay.textContent = 'Time: ' + gameTime.toFixed(1) + 's';
                }
            }, 100);
            
            // Start game loop
            gameLoop();
        }

        // Keyboard Controls
        document.addEventListener('keydown', (e) => {
            keys[e.key] = true;
            // Prevent default scrolling behavior
            if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                e.preventDefault();
            }
        });

        document.addEventListener('keyup', (e) => {
            keys[e.key] = false;
        });

        // Update bounds cache on window resize
        window.addEventListener('resize', () => {
            containerCache = null;
            updateBounds();
        });

        // Jump function
        function jump() {
            if (player.classList.contains('jumping')) return;
            
            player.classList.add('jumping');
            setTimeout(() => {
                player.classList.remove('jumping');
            }, 500);
        }

        // Cache container reference and dimensions
        let containerCache = null;
        let containerWidthCache = 0;
        let containerHeightCache = 0;
        let boundsCache = { minX: 0, maxX: 0 };
        
        // Update cached bounds (call on resize or when needed)
        function updateBounds() {
            if (!containerCache) {
                containerCache = document.getElementById('gameContainer');
                if (!containerCache) return;
            }
            containerWidthCache = containerCache.offsetWidth;
            containerHeightCache = containerCache.offsetHeight;
            
            const roadWidth = Math.max(containerWidthCache * 0.4, 300);
            const roadLeft = (containerWidthCache - roadWidth) / 2;
            const roadRight = roadLeft + roadWidth;
            boundsCache.minX = roadLeft + 40;
            boundsCache.maxX = roadRight - 40;
        }

        // Main Game Loop
        function gameLoop() {
            // Always continue the loop
            requestAnimationFrame(gameLoop);
            
            if (!gameStarted || raceFinished || countdownActive) {
                return;
            }
            
            // Update bounds cache if needed (only once per frame)
            if (!containerCache) {
                updateBounds();
                if (!containerCache) return;
            }
            
            // Handle acceleration (up arrow for speed boost)
            if (keys && keys['ArrowUp']) {
                playerSpeed = Math.min(playerSpeed + 0.2, 5);
            } else {
                playerSpeed = Math.max(playerSpeed - 0.1, 2.5);
            }
            
            // Move player forward (up the screen)
            playerY -= playerSpeed;
            playerProgress = containerHeightCache - playerY;
            
            // Handle steering with smooth movement
            if (keys) {
                const moveSpeed = 3.5;
                if (keys['ArrowLeft'] && playerX > boundsCache.minX) {
                    playerX -= moveSpeed;
                }
                if (keys['ArrowRight'] && playerX < boundsCache.maxX) {
                    playerX += moveSpeed;
                }
            }
            
            // Update player position using transform3d
            const currentLeft = playerX - 30;
            const currentTop = playerY - 30;
            player.style.transform = `translate3d(${currentLeft}px, ${currentTop}px, 0)`;
            
            // Move opponents forward
            moveOpponents();
            
            // Calculate and update positions
            updatePositions();
            
            // Check if anyone finished (player or opponents)
            if (!raceFinished) {
                // Check if player finished
                if (playerY <= finishLineY + 30) {
                    finishRace();
                }
                // Check if any opponent finished (race continues until player finishes)
                opponents.forEach(opp => {
                    if (!opp.finished && opp.y <= finishLineY + 30) {
                        opp.finished = true;
                    }
                });
            }
            
            requestAnimationFrame(gameLoop);
        }

        // Update position display
        function updatePositions() {
            // Create array of all racers with their progress
            const allRacers = [
                { name: 'You', progress: playerProgress, y: playerY, isPlayer: true }
            ];
            
            opponents.forEach(opp => {
                opp.progress = containerHeightCache - opp.y;
                allRacers.push({
                    name: opp.name,
                    progress: opp.progress,
                    y: opp.y,
                    isPlayer: false
                });
            });
            
            // Sort by progress (highest progress = furthest ahead = lower Y = better position)
            allRacers.sort((a, b) => b.progress - a.progress);
            
            // Assign positions
            allRacers.forEach((racer, index) => {
                const position = index + 1;
                if (racer.isPlayer) {
                    // Update player position display
                    const positionText = getPositionText(position);
                    positionDisplay.textContent = `Position: ${positionText}`;
                } else {
                    // Find opponent and update their position
                    const opp = opponents.find(o => o.name === racer.name);
                    if (opp) {
                        opp.position = position;
                    }
                }
            });
        }
        
        // Get position text (1st, 2nd, 3rd, etc.)
        function getPositionText(position) {
            const suffixes = ['th', 'st', 'nd', 'rd'];
            const v = position % 100;
            return position + (suffixes[(v - 20) % 10] || suffixes[v] || suffixes[0]);
        }

        // Move opponents forward
        function moveOpponents() {
            if (!gameStarted || raceFinished || countdownActive) return;
            
            if (!containerCache) {
                updateBounds();
                if (!containerCache) return;
            }
            
            const roadWidth = Math.max(containerWidthCache * 0.4, 300);
            const roadLeft = (containerWidthCache - roadWidth) / 2;
            const roadRight = roadLeft + roadWidth;
            
            opponents.forEach((opp, index) => {
                if (opp.finished) return;
                
                // Move opponent forward (up the screen)
                opp.y -= opp.speed;
                opp.progress = containerHeightCache - opp.y;
                
                // Add slight AI swerving for realism
                const swerveAmount = Math.sin(gameTime * 0.3 + index) * 2;
                opp.x += swerveAmount;
                
                // Keep opponents within road bounds
                if (opp.x < roadLeft + 30) opp.x = roadLeft + 30;
                if (opp.x > roadRight - 30) opp.x = roadRight - 30;
                
                // Update opponent position visually
                const currentLeft = opp.x - 30;
                const currentTop = opp.y - 30;
                opp.element.style.transform = `translate3d(${currentLeft}px, ${currentTop}px, 0)`;
                
                // Check if opponent finished
                if (opp.y <= finishLineY + 30 && !opp.finished) {
                    opp.finished = true;
                }
            });
        }


        // Finish Race
        function finishRace() {
            if (raceFinished) return;
            
            raceFinished = true;
            clearInterval(gameTimer);
            
            // Calculate final positions
            updatePositions();
            
            // Find player's final position
            const allRacers = [
                { name: 'You', progress: playerProgress, y: playerY, isPlayer: true }
            ];
            opponents.forEach(opp => {
                allRacers.push({
                    name: opp.name,
                    progress: opp.progress,
                    y: opp.y,
                    isPlayer: false
                });
            });
            allRacers.sort((a, b) => b.progress - a.progress);
            const playerPosition = allRacers.findIndex(r => r.isPlayer) + 1;
            
            // Show winner screen
            winnerCharacter.textContent = characterEmojis[selectedCharacter];
            winnerTime.textContent = `Finished ${getPositionText(playerPosition)} - Time: ${gameTime.toFixed(1)}s`;
            winnerScreen.style.display = 'flex';
        }

        // Restart Game
        restartButton.addEventListener('click', () => {
            resetGame();
        });

        playAgainButton.addEventListener('click', () => {
            winnerScreen.style.display = 'none';
            resetGame();
        });

        function resetGame() {
            gameStarted = false;
            raceFinished = false;
            clearInterval(gameTimer);
            
            // Reset UI
            characterSelection.style.display = 'flex';
            gameScreen.style.display = 'none';
            startButton.disabled = true;
            characterCards.forEach(c => c.classList.remove('selected'));
            selectedCharacter = null;
            
            // Clean up opponents
            opponents.forEach(opp => {
                if (opp.element && opp.element.parentElement) {
                    opp.element.remove();
                }
            });
            opponents = [];
        }
    </script>
</body>
</html>

